# 医生端智能异常提醒功能增强

## 概述

在现有的 `AlertsScreen` 基础上，增加了基于病人用药服从性和健康指标的智能异常提醒功能，实现了更精准的健康风险评估和个性化医疗建议。

## 主要功能特性

### 1. 智能分析模式
- 在原有告警界面添加"智能分析"模式切换按钮
- 开启后可显示基于AI分析的智能提醒和建议
- 支持实时切换普通模式和智能模式

### 2. 用药依从性智能分析
- **依从性率计算**：自动计算患者的用药依从性百分比
- **连续漏服检测**：识别连续漏服药物的次数和风险等级
- **个性化提醒**：根据不同依从性水平生成相应的处理建议
- **风险分级**：
  - 危急（<50%）：立即联系患者，重新评估治疗方案
  - 高风险（50-70%）：加强患者教育，调整用药方案
  - 中风险（70-85%）：关注并提醒患者按时用药

### 3. 健康指标趋势分析
- **多指标监控**：血压、血糖、心率、体重、尿酸、血脂等
- **趋势识别**：自动识别指标的上升、下降或稳定趋势
- **阈值预警**：基于个性化阈值设置的智能预警
- **关联分析**：分析用药依从性与健康指标变化的关联性

### 4. 智能建议系统
- **个性化建议**：根据患者具体情况生成针对性建议
- **优先级排序**：按照紧急程度对建议进行排序
- **预期效果**：提供采取建议后的预期改善效果
- **建议类型**：
  - 用药调整建议
  - 生活方式改善建议
  - 监测频率调整建议
  - 复诊安排建议

### 5. 综合风险评估
- **多维度评估**：结合用药依从性、健康指标、疾病类型等
- **风险等级**：低风险、中风险、高风险
- **预警机制**：自动识别需要紧急干预的情况

## 界面增强

### 1. 告警卡片增强
- 添加"智能"标识标签，区分普通告警和智能告警
- 集成用药依从性显示（百分比和颜色编码）
- 显示连续漏服次数（红色突出显示）
- 展示健康指标趋势（箭头和颜色指示）
- 智能建议预览（显示主要建议，支持展开查看更多）

### 2. 智能分析模式切换
- 标题栏添加智能分析模式按钮
- 模式切换时自动加载智能分析数据
- 副标题根据模式显示不同描述

### 3. 数据可视化
- 用药依从性进度条和颜色编码
- 健康指标趋势图标和方向指示
- 风险等级徽章和颜色区分

## 技术实现

### 1. 智能分析服务 (`intelligentAlertService.js`)
```javascript
// 主要功能：
- getIntelligentAlerts()      // 获取智能分析的告警
- generateRecommendations()   // 生成智能建议
- getPatientRiskAnalysis()    // 获取患者风险分析
- handleAlert()               // 处理告警
- 优先级和类型管理工具函数
```

### 2. 后端智能分析服务 (`intelligent_alert_service.py`)
```python
# 核心功能：
- analyze_medication_adherence()  # 分析用药依从性
- analyze_health_trends()         # 分析健康指标趋势
- analyze_correlation_risks()     # 分析关联风险
- analyze_long_term_trends()      # 分析长期趋势
- generate_alerts_for_all_patients() # 批量生成智能提醒
```

### 3. 状态管理增强
- 添加 `intelligentMode` 状态控制智能模式
- 添加 `intelligentAlerts` 存储智能分析的告警数据
- 合并原有告警和智能告警数据

## 使用流程

### 1. 医生端操作流程
1. 进入告警界面
2. 点击"智能分析"按钮开启智能模式
3. 系统自动分析患者数据并生成智能提醒
4. 医生查看告警卡片中的智能分析结果：
   - 用药依从性百分比
   - 连续漏服次数
   - 健康指标趋势
   - 智能建议预览
5. 点击告警卡片查看详细分析报告
6. 根据建议采取相应的医疗干预措施

### 2. 智能分析触发条件
- **手动触发**：医生点击智能分析按钮
- **定时触发**：后端定时任务分析患者数据
- **事件触发**：患者上传新的健康数据或漏服药物时

### 3. 告警优先级算法
```javascript
// 优先级判断逻辑：
- 连续漏服 >= 3次 → 危急
- 依从性 < 50% → 危急  
- 连续漏服 >= 2次 → 高
- 依从性 < 70% → 高
- 依从性 < 85% → 中
- 健康指标超出危险阈值 → 危急/高
- 指标趋势恶化 + 依从性差 → 高
```

## 数据结构

### 1. 智能告警数据结构
```javascript
{
  id: 'intelligent_123',
  isIntelligentAlert: true,
  intelligentAnalysis: {
    hasIntelligentData: true,
    recommendations: ['建议1', '建议2'],
    riskLevel: 'high',
    metadata: {
      adherence_rate: 0.65,
      consecutive_missed: 2,
      trend_slope: 0.15,
      latest_value: 145
    }
  }
}
```

### 2. 智能分析元数据
- `adherence_rate`: 用药依从性率 (0-1)
- `consecutive_missed`: 连续漏服次数
- `trend_slope`: 健康指标趋势斜率
- `latest_value`: 最新健康指标值
- `correlation_risk`: 是否存在关联风险

## 样式和UI设计

### 1. 颜色编码系统
- **依从性颜色**：
  - 绿色 (≥85%): 良好
  - 橙色 (70-85%): 一般  
  - 红色 (<70%): 差
- **趋势颜色**：
  - 绿色: 下降/改善
  - 红色: 上升/恶化
  - 灰色: 稳定
- **优先级颜色**：
  - 红色: 危急
  - 橙色: 高
  - 黄色: 中
  - 绿色: 低

### 2. 图标系统
- `analytics`: 智能分析
- `brain`: 智能标识
- `medical`: 用药相关
- `trending-up/down`: 趋势指示
- `bulb`: 智能建议
- `warning`: 风险提醒

## 性能优化

### 1. 数据加载优化
- 懒加载：仅在开启智能模式时加载分析数据
- 缓存机制：缓存分析结果，避免重复计算
- 分页加载：大量告警数据分页显示

### 2. 计算优化
- 异步处理：后台异步计算智能分析结果
- 增量更新：仅更新变化的数据
- 批量处理：批量分析多个患者数据

## 扩展功能

### 1. 可配置的智能规则
- 医生可自定义依从性阈值
- 可调整健康指标的预警范围
- 支持疾病特异性的分析规则

### 2. 机器学习集成
- 基于历史数据的趋势预测
- 个性化风险模型
- 智能建议的效果反馈学习

### 3. 多维度分析
- 患者群体对比分析
- 季节性变化分析
- 药物效果相关性分析

## 总结

通过在现有AlertsScreen基础上集成智能分析功能，实现了：
- ✅ 基于用药依从性的智能提醒
- ✅ 健康指标趋势的自动分析  
- ✅ 个性化医疗建议生成
- ✅ 多维度风险评估
- ✅ 直观的数据可视化
- ✅ 无缝的用户体验

这种增强型的智能异常提醒系统帮助医生更准确地识别患者风险，提供个性化的医疗干预建议，从而提高慢性病管理的效果和患者的健康outcomes。