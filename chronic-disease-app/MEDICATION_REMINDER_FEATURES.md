# 用药提醒功能说明

## 功能概述

用药提醒功能是慢性病管理系统的核心功能之一，旨在帮助患者按时服药，提高用药依从性，改善治疗效果。

## 主要功能

### 1. 今日用药管理
- **今日用药列表**: 显示当天需要服用的所有药物
- **服药状态跟踪**: 实时显示每种药物的服用状态（待服用、已服用、已跳过）
- **一键服药确认**: 点击"已服用"按钮快速记录服药
- **跳过服药**: 支持跳过服药并记录原因

### 2. 用药计划管理
- **用药计划列表**: 显示医生制定的用药计划（患者只读）
- **依从性统计**: 显示每种药物的服用依从性百分比
- **计划详情**: 包含药物名称、剂量、频次、服用时间等信息
- **计划状态**: 显示计划是否处于活跃状态
- **权限控制**: 患者只能查看，不能修改用药计划

### 3. 用药历史记录
- **历史用药记录**: 查看过去的用药记录
- **停药记录**: 记录已停止的用药计划及原因
- **依从性分析**: 分析历史用药依从性

### 4. 智能提醒系统
- **本地通知**: 使用Expo Notifications发送本地提醒
- **定时提醒**: 根据用药计划自动安排提醒时间
- **重复提醒**: 支持重复提醒直到用户确认服药
- **静音时段**: 支持设置静音时段，避免夜间打扰

### 5. 提醒设置
- **基本设置**: 开启/关闭提醒、声音
- **时间设置**: 提前提醒时间、重复间隔
- **静音时段**: 设置免打扰时间段
- **测试功能**: 发送测试通知验证设置

## 技术实现

### 前端架构
- **React Native + Expo**: 跨平台移动应用开发
- **Redux Toolkit**: 状态管理
- **React Native Paper**: UI组件库
- **Expo Notifications**: 本地通知服务

### 后端架构
- **Django REST Framework**: API后端
- **PostgreSQL**: 数据库
- **Celery**: 异步任务处理（可选）

### 核心组件

#### 1. MedicationScreen.js
主要用药管理界面，包含：
- 今日用药列表
- 用药计划展示
- 用药历史记录
- 服药确认功能

#### 2. MedicationSettingsScreen.js
用药提醒设置界面，包含：
- 提醒偏好设置
- 时间配置
- 静音时段设置
- 测试功能

#### 3. medicationReminder.js
用药提醒服务，负责：
- 本地通知管理
- 提醒时间计算
- 服药记录API调用
- 设置持久化

#### 4. medicationSlice.js
Redux状态管理，包含：
- 用药数据状态
- 异步操作处理
- 状态更新逻辑



## 数据模型

### 前端数据模型
```javascript
// 今日用药
{
  id: 1,
  name: '氨氯地平片',
  dosage: '5mg',
  time: '08:00',
  status: 'pending', // pending, taken, skipped
  category: '降压药',
  instructions: '早餐后服用',
  sideEffects: '可能引起头晕、水肿'
}

// 用药计划
{
  id: 1,
  name: '氨氯地平片',
  dosage: '5mg',
  frequency: '每日一次',
  timeOfDay: '早餐后',
  startDate: '2024-01-01',
  endDate: null,
  status: 'active',
  compliance: 85,
  totalDoses: 30,
  takenDoses: 25,
  missedDoses: 5
}

// 提醒偏好
{
  enabled: true,
  sound: true,
  advanceMinutes: 5,
  repeatInterval: 15,
  quietHours: {
    enabled: false,
    startTime: '22:00',
    endTime: '08:00'
  }
}
```

### 后端数据模型
- **Medication**: 药品信息
- **MedicationPlan**: 用药计划
- **MedicationReminder**: 用药提醒记录
- **MedicationStock**: 药品库存（可选）

## API接口

### 用药相关接口
- `GET /medication/today/` - 获取今日用药
- `GET /medication/plans/` - 获取用药计划
- `GET /medication/history/` - 获取用药历史
- `POST /medication/record-taken/` - 记录服药
- `POST /medication/skip/` - 跳过服药
- `GET /medication/compliance-stats/` - 获取依从性统计

## 使用流程

### 1. 患者使用流程
1. **查看今日用药**: 打开应用查看当天需要服用的药物
2. **接收提醒**: 在设定时间接收用药提醒通知
3. **确认服药**: 点击"已服用"按钮记录服药
4. **查看统计**: 定期查看用药依从性统计
5. **查看计划**: 查看医生制定的用药计划（只读）

### 2. 医生管理流程
1. **制定用药计划**: 为患者制定个性化用药方案
2. **监控依从性**: 查看患者的用药依从性数据
3. **调整方案**: 根据依从性情况调整用药计划
4. **权限管理**: 只有医生可以创建、修改和停止用药计划

## 特色功能

### 1. 智能提醒算法
- 根据用药频次自动计算提醒时间
- 支持多种服药时间（餐前、餐后、睡前等）
- 智能重复提醒机制

### 2. 依从性分析
- 实时计算用药依从性
- 提供详细的统计数据
- 支持历史趋势分析

### 3. 个性化设置
- 可自定义提醒偏好
- 支持静音时段设置
- 灵活的提醒时间配置

### 4. 数据同步
- 本地数据与云端同步
- 支持离线使用
- 数据备份和恢复

## 权限控制

### 1. 患者权限
- **查看权限**: 可以查看医生制定的用药计划
- **操作权限**: 可以确认服药、跳过服药
- **设置权限**: 可以调整提醒偏好设置
- **限制**: 不能创建、修改或删除用药计划

### 2. 医生权限
- **管理权限**: 可以创建、修改和停止用药计划
- **监控权限**: 可以查看患者的用药依从性数据
- **调整权限**: 可以根据情况调整用药方案

## 安全考虑

### 1. 数据隐私
- 用药数据本地加密存储
- 云端数据传输加密
- 用户授权管理

### 2. 通知权限
- 请求通知权限
- 优雅处理权限拒绝
- 提供权限说明

### 3. 错误处理
- 网络异常处理
- 数据验证
- 用户友好的错误提示

## 未来扩展

### 1. 高级功能
- 药物相互作用提醒
- 副作用报告
- 药物库存管理
- 用药提醒语音播报

### 2. 智能分析
- AI驱动的依从性预测
- 个性化提醒优化
- 健康效果评估

### 3. 社交功能
- 家人监督功能
- 医生实时监控
- 用药提醒分享

## 技术债务

### 1. 待优化项目
- 时间选择器组件优化
- 通知重复逻辑优化
- 数据缓存策略改进
- 性能优化

### 2. 测试覆盖
- 单元测试
- 集成测试
- 端到端测试
- 用户验收测试

## 权限控制说明

### 重要原则
- **患者角色**: 只能查看和执行用药计划，不能创建或修改
- **医生角色**: 负责制定、修改和管理用药计划
- **数据安全**: 确保用药数据的准确性和安全性

### 患者界面设计
- 用药计划显示"由医生制定"标签
- 提供联系医生的提示信息
- 空状态时引导患者联系医生
- 移除所有添加/编辑用药计划的功能

## 总结

用药提醒功能通过智能化的提醒机制和直观的用户界面，有效帮助患者提高用药依从性。系统严格遵循权限控制原则，确保用药计划由专业医生制定，患者只负责执行和记录。

通过持续的功能优化和用户体验改进，用药提醒功能将成为慢性病管理系统中不可或缺的重要组成部分，同时保证医疗安全性和专业性。 