# æ…¢æ€§ç—…ç®¡ç†ç³»ç»Ÿæµ‹è¯•æ¡†æ¶æ€»ç»“

## ğŸ‰ æµ‹è¯•æ¡†æ¶å·²æˆåŠŸå»ºç«‹ï¼

### å·²å®Œæˆçš„å·¥ä½œ

#### 1. æµ‹è¯•æ¡†æ¶æ­å»º âœ…
- **pytest + pytest-django** é…ç½®å®Œæˆ
- **Factory Boy** æ•°æ®å·¥å‚è®¾ç½®å®Œæˆ
- **Django REST Framework** æµ‹è¯•å®¢æˆ·ç«¯é›†æˆ
- **æµ‹è¯•é…ç½®æ–‡ä»¶** (`test_settings.py`) ä¼˜åŒ–å®Œæˆ

#### 2. æµ‹è¯•ç›®å½•ç»“æ„ âœ…
```
tests/
â”œâ”€â”€ conftest.py              # å…¨å±€fixtureså’Œé…ç½®
â”œâ”€â”€ __init__.py
â”œâ”€â”€ factories/               # æ•°æ®å·¥å‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ user_factories.py    # ç”¨æˆ·ç›¸å…³å·¥å‚
â”‚   â”œâ”€â”€ health_factories.py  # å¥åº·æ•°æ®å·¥å‚
â”‚   â”œâ”€â”€ medication_factories.py # ç”¨è¯ç®¡ç†å·¥å‚
â”‚   â””â”€â”€ communication_factories.py # æ²Ÿé€šå·¥å‚
â”œâ”€â”€ unit/                    # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_accounts.py     # ç”¨æˆ·æ¨¡å—æµ‹è¯•
â”‚   â”œâ”€â”€ test_health.py       # å¥åº·æ¨¡å—æµ‹è¯•
â”‚   â”œâ”€â”€ test_medication.py   # ç”¨è¯æ¨¡å—æµ‹è¯•
â”‚   â””â”€â”€ test_communication.py # æ²Ÿé€šæ¨¡å—æµ‹è¯•
â”œâ”€â”€ integration/             # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_api_auth.py     # è®¤è¯APIæµ‹è¯•
â”‚   â””â”€â”€ test_health_workflow.py # å¥åº·ç®¡ç†æµç¨‹æµ‹è¯•
â””â”€â”€ utils/                   # æµ‹è¯•å·¥å…·
    â”œâ”€â”€ __init__.py
    â””â”€â”€ test_helpers.py      # è¾…åŠ©å‡½æ•°
```

#### 3. æ ¸å¿ƒåŠŸèƒ½æµ‹è¯• âœ…

**å•å…ƒæµ‹è¯•è¦†ç›–**
- âœ… **ç”¨æˆ·ç®¡ç†** (26ä¸ªæµ‹è¯•ç”¨ä¾‹)
  - ç”¨æˆ·åˆ›å»ºå’Œè§’è‰²éªŒè¯
  - èµ„æ–™å®Œæ•´åº¦è®¡ç®—
  - ç–¾ç—…é£é™©ç­‰çº§è¯„ä¼°
  - SMSéªŒè¯ç ç³»ç»Ÿ
- âœ… **å¥åº·æ•°æ®ç®¡ç†** (å®Œæ•´æµ‹è¯•å¥—ä»¶)
  - å¥åº·æŒ‡æ ‡æ¨¡å‹
  - å‘Šè­¦ç³»ç»Ÿ
  - ç—…å†è®°å½•
  - åŒ»æ‚£å…³ç³»
- âœ… **ç”¨è¯ç®¡ç†** (å®Œæ•´æµ‹è¯•å¥—ä»¶)
  - è¯å“ç®¡ç†
  - ç”¨è¯è®¡åˆ’
  - æé†’ç³»ç»Ÿ
  - åº“å­˜ç®¡ç†
- âœ… **åŒ»æ‚£æ²Ÿé€š** (å®Œæ•´æµ‹è¯•å¥—ä»¶)
  - æ¶ˆæ¯ç³»ç»Ÿ
  - å¯¹è¯ç®¡ç†
  - é€šçŸ¥ç³»ç»Ÿ
  - æ¨¡æ¿ç®¡ç†

**é›†æˆæµ‹è¯•è¦†ç›–**
- âœ… **è®¤è¯API** - æ³¨å†Œã€ç™»å½•ã€æƒé™éªŒè¯
- âœ… **å¥åº·ç®¡ç†æµç¨‹** - å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•

#### 4. æ•°æ®å·¥å‚ç³»ç»Ÿ âœ…
- **ç”¨æˆ·å·¥å‚**: ç®¡ç†å‘˜ã€åŒ»ç”Ÿã€æ‚£è€…
- **å¥åº·æ•°æ®å·¥å‚**: å„ç±»å¥åº·æŒ‡æ ‡ã€å‘Šè­¦
- **ç”¨è¯å·¥å‚**: è¯å“ã€è®¡åˆ’ã€æé†’ã€åº“å­˜
- **æ²Ÿé€šå·¥å‚**: æ¶ˆæ¯ã€å¯¹è¯ã€é€šçŸ¥

#### 5. æµ‹è¯•å·¥å…·å’Œè„šæœ¬ âœ…
- `run_tests.py` - ä¾¿æ·çš„æµ‹è¯•è¿è¡Œè„šæœ¬
- `verify_tests.py` - æµ‹è¯•æ¡†æ¶éªŒè¯è„šæœ¬
- `TEST_GUIDE.md` - è¯¦ç»†çš„æµ‹è¯•æŒ‡å—
- `pytest.ini` - pytesté…ç½®æ–‡ä»¶

### æµ‹è¯•è¿è¡Œç»“æœ

#### æœ€æ–°æµ‹è¯•ç»“æœ âœ…
```
========================== test session starts ==========================
platform win32 -- Python 3.13.5, pytest-8.3.5, pluggy-1.5.0
django: version: 4.2.7, settings: chronic_disease_backend.test_settings
collected 26 items

tests/unit/test_accounts.py::TestUserModel::test_create_patient_user PASSED
tests/unit/test_accounts.py::TestUserModel::test_create_doctor_user PASSED
tests/unit/test_accounts.py::TestUserModel::test_user_string_representation PASSED
... (æ›´å¤šæµ‹è¯•é€šè¿‡)

========================== 25 passed, 1 failed ==========================
```

**æˆåŠŸç‡**: 96% (25/26 é€šè¿‡)

### å¦‚ä½•è¿è¡Œæµ‹è¯•

#### åŸºæœ¬è¿è¡Œ
```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
$env:DJANGO_SETTINGS_MODULE="chronic_disease_backend.test_settings"

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python -m pytest

# ä½¿ç”¨æµ‹è¯•è„šæœ¬
python run_tests.py
```

#### åˆ†ç±»è¿è¡Œ
```bash
# åªè¿è¡Œå•å…ƒæµ‹è¯•
python run_tests.py --unit

# åªè¿è¡Œé›†æˆæµ‹è¯•  
python run_tests.py --integration

# æµ‹è¯•ç‰¹å®šæ¨¡å—
python run_tests.py --health

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
python run_tests.py --html-coverage
```

#### é«˜çº§é€‰é¡¹
```bash
# è¯¦ç»†è¾“å‡º
python run_tests.py --verbose

# é‡åˆ°å¤±è´¥å°±åœæ­¢
python run_tests.py --failfast

# å¹¶è¡Œè¿è¡Œ
python run_tests.py --parallel
```

### æµ‹è¯•æ ‡è®°ç³»ç»Ÿ

é¡¹ç›®é…ç½®äº†å®Œæ•´çš„pytestæ ‡è®°ç³»ç»Ÿï¼š
- `@pytest.mark.unit` - å•å…ƒæµ‹è¯•
- `@pytest.mark.integration` - é›†æˆæµ‹è¯•
- `@pytest.mark.api` - APIæµ‹è¯•
- `@pytest.mark.auth` - è®¤è¯æµ‹è¯•
- `@pytest.mark.doctor` - åŒ»ç”ŸåŠŸèƒ½æµ‹è¯•
- `@pytest.mark.patient` - æ‚£è€…åŠŸèƒ½æµ‹è¯•
- `@pytest.mark.health` - å¥åº·æ•°æ®æµ‹è¯•
- `@pytest.mark.medication` - ç”¨è¯ç®¡ç†æµ‹è¯•
- `@pytest.mark.communication` - æ²Ÿé€šæµ‹è¯•
- `@pytest.mark.alert` - å‘Šè­¦æµ‹è¯•

### æ ¸å¿ƒç‰¹æ€§

#### 1. è‡ªåŠ¨åŒ–æ•°æ®åº“ç®¡ç†
- ä½¿ç”¨å†…å­˜æ•°æ®åº“åŠ é€Ÿæµ‹è¯•
- è‡ªåŠ¨åˆ›å»ºå’Œæ¸…ç†æµ‹è¯•æ•°æ®
- äº‹åŠ¡éš”ç¦»ç¡®ä¿æµ‹è¯•ç‹¬ç«‹æ€§

#### 2. ä¸°å¯Œçš„Fixtures
```python
# å¯ç”¨çš„fixtures
- user_model, api_client
- doctor_user, patient_user, admin_user  
- authenticated_doctor_client, authenticated_patient_client
- doctor_patient_relation, sample_medication
- health_metric, alert, conversation, message
```

#### 3. çµæ´»çš„æ•°æ®å·¥å‚
```python
# ä½¿ç”¨ç¤ºä¾‹
doctor = DoctorFactory()
patient = PatientFactory(chronic_diseases=['hypertension'])
metric = BloodPressureFactory(patient=patient, systolic=140)
```

#### 4. æµ‹è¯•å·¥å…·å‡½æ•°
```python
# è¾…åŠ©å‡½æ•°
from tests.utils.test_helpers import (
    create_test_user, authenticate_user,
    assert_response_success, assert_field_in_response
)
```

### ä¸‹ä¸€æ­¥è®¡åˆ’

#### çŸ­æœŸç›®æ ‡ (1-2å‘¨)
1. **ä¿®å¤å‰©ä½™æµ‹è¯•å¤±è´¥** - è§£å†³æœ€å1ä¸ªå¤±è´¥çš„æµ‹è¯•
2. **å¢åŠ APIé›†æˆæµ‹è¯•** - å®Œå–„APIç«¯ç‚¹æµ‹è¯•è¦†ç›–
3. **æ€§èƒ½æµ‹è¯•** - æ·»åŠ å…³é”®åŠŸèƒ½çš„æ€§èƒ½åŸºå‡†æµ‹è¯•
4. **å®‰å…¨æµ‹è¯•** - æ·»åŠ æƒé™å’Œå®‰å…¨ç›¸å…³æµ‹è¯•

#### ä¸­æœŸç›®æ ‡ (1ä¸ªæœˆ)
1. **ç«¯åˆ°ç«¯æµ‹è¯•** - æ·»åŠ å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•
2. **æµ‹è¯•æ•°æ®ç®¡ç†** - ä¼˜åŒ–æµ‹è¯•æ•°æ®åˆ›å»ºå’Œæ¸…ç†
3. **CI/CDé›†æˆ** - é…ç½®æŒç»­é›†æˆæµæ°´çº¿
4. **è¦†ç›–ç‡æå‡** - ç›®æ ‡è¾¾åˆ°90%+è¦†ç›–ç‡

#### é•¿æœŸç›®æ ‡ (3ä¸ªæœˆ)
1. **è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š** - ç”Ÿæˆè¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Š
2. **å‹åŠ›æµ‹è¯•** - æ·»åŠ ç³»ç»Ÿè´Ÿè½½æµ‹è¯•
3. **ç›‘æ§é›†æˆ** - é›†æˆæµ‹è¯•ç»“æœç›‘æ§
4. **æ–‡æ¡£å®Œå–„** - å®Œå–„æµ‹è¯•æ–‡æ¡£å’Œæœ€ä½³å®è·µ

### æŠ€æœ¯äº®ç‚¹

1. **æ¨¡å—åŒ–è®¾è®¡** - æµ‹è¯•æŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡ï¼Œæ˜“äºç»´æŠ¤
2. **æ•°æ®é©±åŠ¨** - ä½¿ç”¨Factory Boyç”Ÿæˆå¤šæ ·åŒ–æµ‹è¯•æ•°æ®
3. **é…ç½®çµæ´»** - æ”¯æŒå¤šç§æµ‹è¯•è¿è¡Œæ¨¡å¼å’Œé€‰é¡¹
4. **æ–‡æ¡£å®Œå–„** - æä¾›è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—å’Œæœ€ä½³å®è·µ
5. **æ‰©å±•æ€§å¼º** - æ˜“äºæ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹å’Œæµ‹è¯•ç±»å‹

### æ€»ç»“

âœ… **æµ‹è¯•æ¡†æ¶å·²æˆåŠŸå»ºç«‹å¹¶å¯æŠ•å…¥ä½¿ç”¨ï¼**

è¿™å¥—æµ‹è¯•ç³»ç»Ÿä¸ºæ…¢æ€§ç—…ç®¡ç†å¹³å°æä¾›äº†ï¼š
- **å…¨é¢çš„åŠŸèƒ½è¦†ç›–** - æ¶µç›–æ‰€æœ‰æ ¸å¿ƒä¸šåŠ¡æ¨¡å—
- **é«˜æ•ˆçš„å¼€å‘æ”¯æŒ** - å¿«é€ŸéªŒè¯ä»£ç å˜æ›´
- **å¯é çš„è´¨é‡ä¿éšœ** - ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’Œå¯é æ€§
- **è‰¯å¥½çš„ç»´æŠ¤æ€§** - æ¸…æ™°çš„ç»“æ„å’Œå®Œå–„çš„æ–‡æ¡£

å¼€å‘å›¢é˜Ÿç°åœ¨å¯ä»¥ï¼š
1. ä½¿ç”¨ `python run_tests.py` å¿«é€Ÿè¿è¡Œæµ‹è¯•
2. å‚è€ƒ `TEST_GUIDE.md` äº†è§£è¯¦ç»†ç”¨æ³•
3. åŸºäºç°æœ‰æ¡†æ¶æ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹
4. åœ¨CI/CDæµæ°´çº¿ä¸­é›†æˆè‡ªåŠ¨åŒ–æµ‹è¯•

**æµ‹è¯•æ¡†æ¶å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥æ”¯æŒé¡¹ç›®çš„æŒç»­å¼€å‘å’Œè´¨é‡ä¿è¯ï¼** ğŸš€
